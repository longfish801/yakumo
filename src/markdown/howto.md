# 使い方

[TOC levels=2-6]

## 変換処理の流れ

　yakumoは以下の工程で、特定の記法に従うテキストを目的の形式へ変換します。

1. 変換対象を解析します。
   1. 変換対象のテキストをbltxt文書に整形します。
      - switemスクリプトを用いてテキストをbltxt文書に整形します。
        - switemについては [switem](/maven/switem/) を参照してください。
   2. bltxt文書を解析します。
      - bltxt文書はXMLに似た、タグを用いて階層関係を表現した文書です。
        - bltxt文書については [bltxt](/maven/bltxt/) を参照してください。
2. 変換結果を整形します。
   1. クロージャで目的の形式へ変換します。
      - クロージャでbltxt文書を目的の形式へ変換します。
      - クロージャはclmapスクリプトに定義します。
        - clmapスクリプトについては [clmap](/maven/clmap/) を参照してください。
      - 最上位の無名のマップに属する、無名のクロージャを呼びます。
        - 第一引数として変換結果キーを渡します。
        - 第二引数として変換対象キーとBLtxtインスタンスとのマップを渡します。
        - 戻り値としてテンプレートに適用するバインド変数のマップを返してください。
        - 大域変数としてログ出力子である "fprint"が使えます。
   2. テンプレートにバインド変数を適用して出力します。
3. 必要に応じて関連ファイルを出力します。
   - 関連ファイルとは、変換結果に併せて出力が必要な静的ファイルです。
   - たとえば HTMLへの変換であれば CSSファイルや JavaScriptファイルなどが相当します。

## 資材スクリプト

　変換に必要な各種資材をまとめたものが変換資材です。以下のうち、最低ひとつのファイルから構成されます。

* switemスクリプト
* clmapスクリプト
* テンプレートファイル

　変換資材の作成の仕方として、以下の二種類があります。

* クラスパス上にリソースとして作成する場合
* ファイルとして作成する場合

　資材を構成するファイルへのパスを定義するのが資材スクリプトです。
　資材スクリプトのファイル名は「material.groovy」固定です。

　変換資材名は、資材スクリプトを格納しているフォルダ名あるいはフォルダへのパスです。
　慣例として、bltxt記法へ変換する資材は先頭一文字を"f"(from)にしてください。
　bltxt文書を目的の記法へ変換するための資材ならば先頭一文字を"t"(to)にしてください。

　以下のバインド変数を利用できます。

yakumo
: YmoScriptクラスのインスタンス。詳細は [Groovydoc](groovydoc/) を参照してください。

convName
: 変換資材名。変換資材がリソースの場合のみ。

convDir
: 資材スクリプト格納フォルダ（java.io.File）。変換資材がフォルダの場合のみ。

　Yakumo#loadメソッドに渡すクロージャで、必要な他の変換資材を読みこみます。
　クロージャ内では以下のメソッドを使用できます。委任クラスはMaterialLoaderです。引数など詳細は [Groovydoc](groovydoc/) を参照してください。

material
: 利用する他の変換資材を設定します。

　Yakumo#materialメソッドに渡すクロージャで、変換資材を設定します。
　クロージャ内では以下のメソッドを使用できます。委任クラスはConvertMaterialです。引数など詳細は [Groovydoc](groovydoc/) を参照してください。

switem
: switemスクリプトを設定します。

clmap
: clmapスクリプトを設定します。

clmapProps
: クロージャマップに大域変数をバインドします。

template
: テンプレートを設定します。

## 変換スクリプト

　変換のために実行するのが変換スクリプトです。
　利用する変換資材を定義したり、変換後に実行する処理を記述したりします。
　Groovy DSLのため、Groovyスクリプトとして処理を記述できます。
　以下のバインド変数を利用できます。

script
: 変換スクリプト（java.io.File）

yakumo
: YmoDocumentクラスのインスタンス。詳細は [Groovydoc](groovydoc/) を参照してください。

convDir
: 資材スクリプトの格納フォルダ（java.io.File）

　Yakumo#loadメソッドに渡すクロージャで、必要な他の変換資材を読みこみます。
　詳細は「[変換資材](#変換資材)」を参照してください。

　Yakumo#scriptメソッドに渡すクロージャで、変換スクリプトを設定します。
　クロージャ内では以下のメソッドを使用できます。委任クラスはConvertScriptです。引数など詳細は [Groovydoc](groovydoc/) を参照してください。

targets
: 変換対象について設定するためのクロージャを渡します。
: 委任クラスはConvertTargetsです。

results
: 変換結果について設定するためのクロージャを渡します。
: 委任クラスはConvertResultsです。

doFirst
: 解析前に実行する処理を設定します。

doBetween
: 解析後、整形前に実行する処理を設定します。
: 引数として変換対象キーとBLtxtインスタンスとのマップを渡します。

doLast
: 整形および関連ファイルのコピー後に実行する処理を設定します。

## 関連ファイル

　関連ファイルとは、変換結果に併せて出力が必要な静的ファイルです。

　Yakumo#relatedメソッドに渡すクロージャで、関連ファイルを設定します。
　関連ファイルは資材スクリプト、変換スクリプトどちらでも設定できます。

　クロージャ内では以下のメソッドを使用できます。委任クラスはRelatedSourcesです。引数など詳細は [Groovydoc](groovydoc/) を参照してください。

outDir
: 関連ファイルの出力ディレクトリを設定します。

copyMode
: 関連ファイルのコピーモードを設定します。

source
: 関連ファイルを設定します。

removeSet
: セット名に対応する関連ファイルをすべてコピー対象から除外します。
: 利用する変換資材が設定した関連ファイルをコピーしたくない場合に利用してください。
