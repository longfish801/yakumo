<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WashScr記法</title>
<link href="/yakumo/_asset/style.css" rel="stylesheet">
<script src="/yakumo/_asset/script.js"></script>
</head>
<body>

<header class="container">
<h1>WashScr記法</h1>

<nav class="list-group">
<a href="#id2_1" class="list-group-item">概要</a>
<a href="#id2_2" class="list-group-item">構成</a>
<a href="#id2_3" class="list-group-item">範囲指定タグ</a>
<a href="#id3_4" class="list-group-item">　sliceタグ</a>
<a href="#id3_5" class="list-group-item">　betweenタグ</a>
<a href="#id2_6" class="list-group-item">処理タグ</a>
<a href="#id3_7" class="list-group-item">　replaceタグ</a>
<a href="#id3_8" class="list-group-item">　reprexタグ</a>
<a href="#id3_9" class="list-group-item">　callタグ</a>
<a href="#id2_10" class="list-group-item">クロージャ呼び出しについて</a>
</nav>
</header>

<article class="container">
<h2><a name="id2_1"></a>概要</h2>

<p>　WashScr記法は、Washスクリプトのための記法です。<br/>
　Washスクリプトは、テキストの整形に特化したスクリプトです。<br/>
　文法は<a href="tpac.html">TPAC記法</a>をベースにしています。<br/>
　<a href="clmap.html">Clmap記法</a>の拡張であり、Clmap記法のタグが使用できます。</p>

<h2><a name="id2_2"></a>構成</h2>

<p>　ファイルに記述する場合、文字コードは UTF-8としてください。<br/>
　Clmap記法で使用できるタグはすべて使用できます。</p>

<p>　先頭に宣言をひとつ持ちます。<br/>
　タグ名は「washscr」です。<br/>
　スペース区切りで任意の名前を付与してください。名前は省略可です。</p>

<pre class="code">
#! washscr 整形スクリプト
</pre>

<p>　宣言の次行から、タグを記述します。<br/>
　タグには範囲指定タグと処理タグの二種類があります。<br/>
　範囲指定タグによって指定された範囲内の文字列に対し、処理タグで指定された処理をします。</p>

<h2><a name="id2_3"></a>範囲指定タグ</h2>

<h3><a name="id3_4"></a>sliceタグ</h3>

<p>　betweenタグは、区切り行で分割した各行を処理タグに渡します。<br/>
　sliceタグの後に、処理名称を記述してください。</p>

<p>　div属性には分割の区切りとなる行を正規表現で指定します。<br/>
　デフォルトは空行を意味する正規表現(^$)です。</p>

<p>　divhandle属性には区切り行の扱いを指定します。以下のいずれかを指定できます。<br/>
　デフォルトは &quot;exclude&quot;です。<br/>
　&quot;include&quot;の場合、区切り行は範囲の先頭に付与します。</p>

<ul>
<li>include - 区切り行を含めて処理タグに渡します。</li>
<li>exclude - 区切り行は処理タグに渡さず、そのまま残します。</li>
<li>delete - 区切り行を削除します。</li>
</ul>

<p>　処理タグによる処理の対象とするか、クロージャで判断させることができます。<br/>
　judge属性にクロージャのコンビキーを指定します。<br/>
　クロージャには引数List&lt;String&gt; linesを渡します。<br/>
　linesは、分割した文字列を行毎に分割したリストです。<br/>
　処理対象とするか否かを boolean値で返してください。<br/>
　judge属性の指定がない場合は、すべて処理対象となります。</p>

<pre class="code">
## slice 分割
#-div ^$
#-divhandle include
#-judge slice#judge
## map replace
# args
	List&lt;String&gt; lines
# closure judge
	return (line[0] == '--- 対象外 ---')? false : true;
</pre>

<h3><a name="id3_5"></a>betweenタグ</h3>

<p>　betweenタグは、特定の開始行から終了行の範囲の行を処理タグに渡します。<br/>
　範囲外の文字列はそのまま残ります。<br/>
　betweenタグの後に、処理名称を記述してください。</p>

<p>　bgn属性には開始行を正規表現で指定します。<br/>
　必須項目です。</p>

<p>　end属性には終了行を正規表現で指定します。<br/>
　デフォルトは空文字です。<br/>
　空文字の場合、開始行と一致する文字列を終了行とみなします。<br/>
　終了行は開始行の次行から探します。<br/>
　開始行はあるのに終了行がないままファイル末端を迎えた場合は、ファイル末端を終了行とみなします。</p>

<p>　divhandle属性には区切り行の扱いを指定します。<br/>
　詳細はsliceタグを参照してください。</p>

<p>　処理を実施するか判断するクロージャを judge属性で指定できます。<br/>
　詳細はsliceタグを参照してください。</p>

<pre class="code">
## between 範囲分割
#-bgn ^\~{5,}$
#-end ^\_{5,}$
#-divhandle include
</pre>

<h2><a name="id2_6"></a>処理タグ</h2>

<h3><a name="id3_7"></a>replaceタグ</h3>

<p>　固定文字列での置換をします。<br/>
　replaceタグの後に、処理名称を記述してください。</p>

<p>　後続行には、検索文字列と置換後文字列をタブ区切りで記述します。<br/>
　改行区切りで複数指定できます。<br/>
　改行コードを含む検索文字列を指定しても有効とはなりません。</p>

<p>　置換を実行するか否か判定する場合、judge属性を指定します。<br/>
　クロージャのコンビキーを指定します。<br/>
　クロージャには引数List&lt;String&gt; linesを渡します。<br/>
　引数linesは、範囲内の文字列を行毎に分割したリストです。<br/>
　処理対象とするか否かを boolean値で返してください。<br/>
　judge属性の指定がない場合は、すべて処理対象となります。</p>

<p>　対象文字列の前処理をする場合、first属性を指定します。<br/>
　クロージャのコンビキーを指定します。<br/>
　クロージャには引数List&lt;String&gt; linesを渡します。<br/>
　引数linesは、範囲内の文字列を行毎に分割したリストです。<br/>
　処理結果を List&lt;String&gt;で返してください。<br/>
　なお、前処理よりも先に judge属性による判定を実施します。</p>

<p>　対象文字列の後処理をする場合、last属性を指定します。<br/>
　置換後の文字列を引数 linesに渡すこと以外は first属性と同じです。</p>

<pre class="code">
# replace 固定置換
#-judge replace#判定
#-first replace#前処理
#-last replace#後処理
テスト	試験
サンプル	例
## map replace
# args
	List&lt;String&gt; lines
# closure 判定
	return (line[0] == '--- 対象外 ---')? false : true;
# closure 前処理
	return lines.collect { &quot;${it} -サンプル&quot; };
# closure 後処理
	return lines.collect { &quot;テスト- ${it}&quot; };
</pre>

<h3><a name="id3_8"></a>reprexタグ</h3>

<p>　正規表現での置換をします。<br/>
　reprexタグの後に、処理名称を記述してください。</p>

<p>　後続行には、検索文字列と置換後文字列をタブ区切りで記述します。<br/>
　改行区切りで複数指定できます。<br/>
　改行コードを含む検索文字列を指定しても有効となりません。</p>

<p>　judge属性、first属性、last属性を指定できます。<br/>
　詳細はreplaceタグを参照してください。</p>

<pre class="code">
# reprex 正規表現置換
テスト(\d+)	サンプル#$1
テスト(\d+)	試験#$1
</pre>

<h3><a name="id3_9"></a>callタグ</h3>

<p>　範囲文字列の処理をするクロージャを呼ぶことができます。<br/>
　callタグの後に、処理名称を記述してください。</p>

<p>　combi属性にクロージャのコンビキーを指定します。必須です。<br/>
　クロージャには引数List&lt;String&gt; linesを渡します。<br/>
　引数linesは、分割した文字列を行毎に分割したリストです。<br/>
　暗黙の引数 config.idxで呼び出し順（0始まり）を参照できます。<br/>
　config.isLastの値が trueのときは最後の要素です。<br/>
　処理結果を List&lt;String&gt;で返してください。</p>

<p>　judge属性、first属性、last属性を指定できます。<br/>
　詳細はreplaceタグを参照してください。</p>

<pre class="code">
# call 範囲処理
#-combi range#add
## map range
# args
	List&lt;String&gt; lines
# closure add
	lines.add(0, '--- ここから ---');
	lines &lt;&lt; '--- ここまで ---';
	return lines;
</pre>

<h2><a name="id2_10"></a>クロージャ呼び出しについて</h2>

<p>　クロージャ呼び出し時、暗黙の引数 configに以下の情報を格納します。</p>

<dl>
<dt>config.{ID}.index</dt>
<dd>範囲指定タグで分割された範囲の位置（0始まり）</dd>
<dt>config.{ID}.isLast</dt>
<dd>範囲指定タグで分割された範囲の、最後の範囲か否か</dd>
</dl>

<p>　IDは、タグ名と名前を半角シャープ(#)で連結した文字列です。<br/>
　たとえば以下は、まず空行区切りで分割します。<br/>
　先頭の範囲のみ「--- ここから ---」という行を先頭に付与します。<br/>
　末尾の範囲のみ「--- ここまで ---」という行を末尾に付与します。</p>

<pre class="code">
# slice
# call 範囲指定
#-combi #先頭と末尾に追記
## map
# args
	List&lt;String&gt; lines
# closure 先頭と末尾に追記
	if (config.'call#範囲指定'.idx == 0) lines.add(0, '--- ここから ---');
	if (config.'call#範囲指定'.isLast) lines &lt;&lt; '--- ここまで ---';
	return lines;
</pre>

<p>　各タグの処理は並列実行されます。<br/>
　このため、たとえば初めのほうのタグで configに設定した値が、必ずしも後のほうのタグで参照できるとは限らないため注意してください。</p>

<p>以上</p>

</article>

<footer class="container">
<a href="index.html">戻る</a>
</footer>

</body>
</html>
